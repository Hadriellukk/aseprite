name: Build Aseprite for Windows

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Aseprite
      uses: actions/checkout@v4
      with:
        repository: aseprite/aseprite
        submodules: recursive

    - name: Setup MSVC environment
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install dependencies (CMake, Ninja)
      run: |
        choco install -y cmake ninja

    - name: Download and extract Skia (m124)
      run: |
        Invoke-WebRequest -Uri "https://github.com/aseprite/skia/releases/download/m124-08a5439a6b/Skia-Windows-Release-x64.zip" -OutFile "skia.zip"
        Expand-Archive -Path "skia.zip" -DestinationPath "C:\deps\skia"

    - name: Configure Aseprite
      run: |
        mkdir build
        cmake -S . -B build -G Ninja `
          -DCMAKE_BUILD_TYPE=Release `
          -DLAF_BACKEND=skia `
          -DSKIA_DIR=C:\deps\skia `
          -DSKIA_LIBRARY_DIR=C:\deps\skia\out\Release-x64 `
          -DSKIA_LIBRARY=C:\deps\skia\out\Release-x64\skia.lib `
          -DUSE_SHARED_CURL=OFF `
          -DUSE_SHARED_ZLIB=OFF `
          -DUSE_SHARED_LIBPNG=OFF `
          -DUSE_SHARED_TINYXML=OFF `
          -DUSE_SHARED_PIXMAN=OFF `
          -DUSE_SHARED_FREETYPE=OFF `
          -DUSE_SHARED_HARFBUZZ=OFF `
          -DENABLE_UPDATER=OFF

    - name: Build Aseprite
      run: cmake --build build --config Release

    - name: Prepare Release Folder
      run: |
        mkdir release
        copy build\bin\aseprite.exe release\
        xcopy /E /I data release\data
        # Se ainda houver dependência de DLLs do OpenSSL, tentamos copiá-las se existirem
        if (Test-Path "C:\Program Files\OpenSSL\bin\libcrypto-3-x64.dll" ) {
            copy "C:\Program Files\OpenSSL\bin\libcrypto-3-x64.dll" release\
        }
        if (Test-Path "C:\Program Files\OpenSSL\bin\libssl-3-x64.dll") {
            copy "C:\Program Files\OpenSSL\bin\libssl-3-x64.dll" release\
        }

    - name: Upload Aseprite Bundle
      uses: actions/upload-artifact@v4
      with:
        name: aseprite-windows-full
        path: release/
